{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="max-w-lg mx-auto bg-white shadow-2xl rounded-xl overflow-hidden">
        <div class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white py-4">
            <h2 class="text-2xl font-bold text-center">Voter Registration</h2>
        </div>
        
        <form action="/register" method="post" id="registrationForm" class="p-6 space-y-6">
            <div>
                <label for="aadharNumber" class="block text-sm font-medium text-gray-700 mb-2">
                    Aadhar Card Number
                </label>
                <input 
                    type="text" 
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" 
                    id="aadharNumber" 
                    name="aadhar_number" 
                    placeholder="Enter 12-digit Aadhar Number" 
                    required 
                    pattern="\d{12}" 
                    maxlength="12" 
                    minlength="12"
                >
            </div>

            <div id="cameraSection" class="hidden text-center">
                <h3 class="text-lg font-semibold text-gray-800 mb-4">Face Capture</h3>
                <video id="videoElement" class="w-full h-auto rounded-lg mb-4" autoplay playsinline></video>
                <canvas id="captureCanvas" class="hidden"></canvas>
                <p class="text-sm text-gray-600 mb-4">
                    Position your face in the camera frame and stay still
                </p>
            </div>

            <div class="bg-blue-50 border-l-4 border-blue-500 p-4 text-blue-700">
                <strong>Registration Instructions:</strong>
                <ul class="list-disc list-inside space-y-1 mt-2">
                    <li>Enter your 12-digit Aadhar number</li>
                    <li>Click Register to start face capture</li>
                    <li>Look directly at the camera</li>
                    <li>Remain still for 5 seconds</li>
                </ul>
            </div>

            <div>
                <button 
                    type="submit" 
                    id="registerButton"
                    class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition-colors duration-300 focus:outline-none focus:ring-2 focus:ring-green-500"
                >
                    Register
                </button>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const aadharInput = document.getElementById('aadharNumber');
    const registerButton = document.getElementById('registerButton');
    const cameraSection = document.getElementById('cameraSection');
    const videoElement = document.getElementById('videoElement');
    const captureCanvas = document.getElementById('captureCanvas');
    
    registerButton.addEventListener('click', async function(e) {
        // Validate Aadhar number first
        if (!aadharInput.checkValidity()) {
            aadharInput.reportValidity();
            return;
        }
        
        e.preventDefault();
        
        // Show camera section
        cameraSection.classList.remove('hidden');
        
        // Access camera
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            
            // Capture after 5 seconds
            setTimeout(() => {
                // Capture frame
                captureCanvas.width = videoElement.videoWidth;
                captureCanvas.height = videoElement.videoHeight;
                const context = captureCanvas.getContext('2d');
                context.drawImage(videoElement, 0, 0);
                
                // Convert to blob
                captureCanvas.toBlob(blob => {
                    // Create FormData
                    const formData = new FormData(document.getElementById('registrationForm'));
                    formData.append('face_capture', blob, 'face_capture.jpg');
                    
                    // Stop video stream
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Submit form via AJAX
                    fetch('/register', {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            alert('Registration Successful!');
                            window.location.href = '/';
                        } else if (data.status === 'already_registered') {
                            alert(data.message);
                        } else {
                            alert('Registration failed: ' + data.message);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Registration failed');
                    });
                }, 'image/jpeg');
            }, 5000);
        } catch (err) {
            console.error('Camera access error:', err);
            alert('Could not access camera. Please check permissions.');
        }
    });
});
</script>
{% endblock %}